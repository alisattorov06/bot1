<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUBG UC Farm WebApp</title>
    <style>
        /* CSS Styles - PUBG uslubi: qora, kulrang, oltin rang palitrasi */
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #1a1a1a; /* Qora fon */
            color: #ffd700; /* Oltin matn */
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        .container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .nav {
            display: flex;
            justify-content: space-around;
            background-color: #333; /* Kulrang */
            padding: 10px;
            border-top: 1px solid #ffd700; /* Oltin border */
        }
        .nav button {
            background: none;
            border: none;
            color: #ffd700;
            font-size: 24px;
            cursor: pointer;
        }
        .nav button.active {
            color: #fff; /* Faol holatda oq */
        }
        /* Neon borderlar va shaffof cardlar */
        .card {
            background: rgba(51, 51, 51, 0.8); /* Shaffof kulrang */
            border: 1px solid #ffd700;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 0 10px #ffd700; /* Neon effekt */
        }
        .button {
            background-color: #ffd700;
            color: #1a1a1a;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        .button:hover {
            background-color: #fff;
        }
        .hidden {
            display: none;
        }
        /* Smooth transition uchun */
        .page {
            transition: opacity 0.3s ease;
        }
        .page.hidden {
            opacity: 0;
        }
        /* Bosish tugmasi */
        #tapButton {
            width: 100%;
            height: 200px;
            font-size: 48px;
            background: url('pubg-tap-bg.png') center/cover; /* PUBG dizayn rasmi, o'zingiz qo'shing */
        }
        /* Level progress */
        .progress {
            background: #333;
            height: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .progress-bar {
            background: #ffd700;
            height: 100%;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sahifa 1: Bosish va Ball yig'ish -->
        <div id="page1" class="page">
            <h2>ðŸŽ® Bosish va Ball yig'ish</h2>
            <div class="card">
                <p>Balans: <span id="balance">0</span> ball</p>
                <p>Level: <span id="level">1</span></p>
                <p>Energiya: <span id="energy">10/10</span></p>
                <p>Kutish vaqti: <span id="cooldown">0</span> soat</p>
                <button id="tapButton" class="button">Bosish (+<span id="tapValue">0.1</span>)</button>
                <div class="progress">
                    <div id="levelProgress" class="progress-bar" style="width: 0%;"></div>
                </div>
                <button id="boostButton" class="button hidden">Energiya Boost (5 ball)</button>
            </div>
        </div>

        <!-- Sahifa 2: Kanallarga Obuna & Referal -->
        <div id="page2" class="page hidden">
            <h2>ðŸ“¢ Kanallarga Obuna & Referal</h2>
            <div class="card">
                <h3>Kanallar ro'yxati</h3>
                <ul id="channelsList"></ul>
            </div>
            <div class="card">
                <h3>Referal havola</h3>
                <p id="referralLink">t.me/botusername?start=refYourID</p>
                <button id="copyReferral" class="button">Nusxa olish</button>
            </div>
        </div>

        <!-- Sahifa 3: UC Ayirboshlash -->
        <div id="page3" class="page hidden">
            <h2>ðŸ’± UC Ayirboshlash</h2>
            <div id="ucPackages" class="card">
                <!-- Paketlar dinamik qo'shiladi -->
            </div>
            <div class="card">
                <input type="text" id="pubgID" placeholder="PUBG ID kiriting">
                <button id="exchangeButton" class="button">Ayirboshlash</button>
            </div>
        </div>

        <!-- Admin Panel (Alohida, admin uchun) -->
        <div id="adminPage" class="page hidden">
            <h2>Admin Panel</h2>
            <div class="card">
                <h3>Foydalanuvchilar statistikasi</h3>
                <p>Jami foydalanuvchilar: <span id="totalUsers">0</span></p>
                <h4>TOP 10</h4>
                <ul id="topUsers"></ul>
            </div>
            <div class="card">
                <h3>Kanallarni boshqarish</h3>
                <input type="text" id="newChannel" placeholder="Kanal username">
                <button id="addChannel" class="button">Qo'shish</button>
                <ul id="adminChannels"></ul>
            </div>
            <div class="card">
                <h3>Mass Send</h3>
                <textarea id="massMessage" placeholder="Xabar matni"></textarea>
                <button id="sendMass" class="button">Yuborish</button>
            </div>
            <div class="card">
                <h3>UC So'rovlari</h3>
                <ul id="ucRequests"></ul>
            </div>
        </div>
    </div>

    <!-- Navigatsiya -->
    <div class="nav">
        <button data-page="page1" class="active">ðŸŽ®</button>
        <button data-page="page2">ðŸ“¢</button>
        <button data-page="page3">ðŸ’±</button>
    </div>

    <script>
        // JavaScript - Frontend Logikasi
        const telegram = window.Telegram.WebApp; // Telegram WebApp API
        telegram.ready();

        // O'zgaruvchilar (backenddan olish kerak, bu misol uchun)
        let balance = 0;
        let level = 1;
        let energy = 10;
        let cooldown = 0;
        let tapValue = 0.1;
        let nextLevelPoints = 50;
        let currentProgress = 0;
        let userId = telegram.initDataUnsafe.user.id; // Foydalanuvchi ID
        let isAdmin = false; // Backenddan tekshirish

        // Sahifalarni almashtirish
        document.querySelectorAll('.nav button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
                document.getElementById(btn.dataset.page).classList.remove('hidden');
                document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });

        // Backend bilan aloqa (misol uchun fetch orqali)
        async function fetchBackend(endpoint, data) {
            return fetch('/api/' + endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(res => res.json());
        }

        // Balansni yangilash
        async function updateBalance() {
            const data = await fetchBackend('get_balance', { user_id: userId });
            balance = data.balance;
            level = data.level;
            energy = data.energy;
            cooldown = data.cooldown;
            tapValue = 0.1 + (level - 1) * 0.01;
            currentProgress = data.progress;
            nextLevelPoints = data.next_level;

            document.getElementById('balance').textContent = balance.toFixed(1);
            document.getElementById('level').textContent = level;
            document.getElementById('energy').textContent = `${energy}/10`;
            document.getElementById('cooldown').textContent = cooldown;
            document.getElementById('tapValue').textContent = tapValue.toFixed(2);
            document.getElementById('levelProgress').style.width = `${(currentProgress / nextLevelPoints) * 100}%`;

            if (balance >= 20) {
                document.getElementById('boostButton').classList.remove('hidden');
            }
        }

        // Bosish tugmasi
        document.getElementById('tapButton').addEventListener('click', async () => {
            if (energy > 0 && cooldown === 0) {
                balance += tapValue;
                energy--;
                await fetchBackend('tap', { user_id: userId });
                updateBalance();
                if (energy === 0) {
                    cooldown = 2; // 2 soat
                    setTimeout(() => {
                        energy = 10;
                        cooldown = 0;
                        updateBalance();
                    }, 2 * 60 * 60 * 1000); // 2 soat
                }
                // Level oshirish
                if (balance >= nextLevelPoints) {
                    level++;
                    nextLevelPoints *= 2;
                    await fetchBackend('level_up', { user_id: userId });
                }
            }
        });

        // Energiya Boost
        document.getElementById('boostButton').addEventListener('click', async () => {
            if (balance >= 5 && cooldown > 0) {
                balance -= 5;
                cooldown -= 0.5; // Yarim soat qisqartirish
                await fetchBackend('boost', { user_id: userId });
                updateBalance();
            }
        });

        // Kanallar ro'yxati
        async function loadChannels() {
            const channels = await fetchBackend('get_channels');
            const list = document.getElementById('channelsList');
            list.innerHTML = '';
            channels.forEach(channel => {
                const li = document.createElement('li');
                li.innerHTML = `<a href="https://t.me/${channel.username}" target="_blank">${channel.name}</a> <button onclick="subscribe('${channel.id}')">Obuna bo'lish</button>`;
                list.appendChild(li);
            });
        }

        async function subscribe(channelId) {
            // Bot tekshiradi
            const result = await fetchBackend('subscribe_channel', { user_id: userId, channel_id: channelId });
            if (result.success) {
                balance += 5;
                updateBalance();
            }
        }

        // Referal havola
        async function loadReferral() {
            const ref = await fetchBackend('get_referral', { user_id: userId });
            document.getElementById('referralLink').textContent = ref.link;
        }

        document.getElementById('copyReferral').addEventListener('click', () => {
            navigator.clipboard.writeText(document.getElementById('referralLink').textContent);
        });

        // UC Paketlari
        const packages = [
            { uc: 60, points: 6000 },
            { uc: 325, points: 32500 }
        ];

        function loadPackages() {
            const container = document.getElementById('ucPackages');
            packages.forEach(pkg => {
                const card = document.createElement('div');
                card.classList.add('card');
                card.innerHTML = `<p>${pkg.uc} UC = ${pkg.points} ball</p><button onclick="selectPackage(${pkg.uc}, ${pkg.points})">Tanlash</button>`;
                container.appendChild(card);
            });
        }

        let selectedPkg = null;
        function selectPackage(uc, points) {
            selectedPkg = { uc, points };
        }

        document.getElementById('exchangeButton').addEventListener('click', async () => {
            const pubgId = document.getElementById('pubgID').value;
            if (selectedPkg && balance >= selectedPkg.points) {
                await fetchBackend('exchange_uc', { user_id: userId, pubg_id: pubgId, uc: selectedPkg.uc, points: selectedPkg.points });
                balance -= selectedPkg.points;
                updateBalance();
                telegram.showAlert('So\'rov yuborildi!');
            }
        });

        // Admin Panel
        async function loadAdmin() {
            if (!isAdmin) return;
            document.getElementById('adminPage').classList.remove('hidden');
            // Statistika
            const stats = await fetchBackend('admin_stats');
            document.getElementById('totalUsers').textContent = stats.total;
            const topList = document.getElementById('topUsers');
            topList.innerHTML = '';
            stats.top.forEach(user => {
                topList.innerHTML += `<li>${user.name}: ${user.balance} ball</li>`;
            });

            // Kanallar
            const adminChannels = document.getElementById('adminChannels');
            adminChannels.innerHTML = '';
            const channels = await fetchBackend('get_channels');
            channels.forEach(ch => {
                adminChannels.innerHTML += `<li>${ch.name} <button onclick="removeChannel('${ch.id}')">O'chirish</button></li>`;
            });
        }

        document.getElementById('addChannel').addEventListener('click', async () => {
            const username = document.getElementById('newChannel').value;
            await fetchBackend('add_channel', { username });
            loadAdmin();
        });

        async function removeChannel(id) {
            await fetchBackend('remove_channel', { id });
            loadAdmin();
        }

        document.getElementById('sendMass').addEventListener('click', async () => {
            const message = document.getElementById('massMessage').value;
            await fetchBackend('mass_send', { message });
        });

        // UC So'rovlari
        async function loadRequests() {
            const requests = await fetchBackend('get_uc_requests');
            const list = document.getElementById('ucRequests');
            list.innerHTML = '';
            requests.forEach(req => {
                list.innerHTML += `<li>${req.user}: ${req.uc} UC <button onclick="approveRequest('${req.id}')">Tasdiqlash</button> <button onclick="rejectRequest('${req.id}')">Bekor</button></li>`;
            });
        }

        async function approveRequest(id) {
            await fetchBackend('approve_uc', { id });
            loadRequests();
        }

        async function rejectRequest(id) {
            await fetchBackend('reject_uc', { id });
            loadRequests();
        }

        // Inicializatsiya
        async function init() {
            const userData = await fetchBackend('init_user', { user_id: userId, ref: telegram.initDataUnsafe.start_param });
            isAdmin = userData.is_admin;
            updateBalance();
            loadChannels();
            loadReferral();
            loadPackages();
            if (isAdmin) loadAdmin();
            loadRequests(); // Admin uchun
        }

        init();

        // Real-time yangilash uchun interval
        setInterval(updateBalance, 60000); // Har minutda
    </script>
</body>
</html>
